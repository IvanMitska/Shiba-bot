require('dotenv').config();
const { Telegraf, Markup } = require('telegraf');

const bot = new Telegraf(process.env.BOT_TOKEN);

// ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /start Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð°
bot.command('start', async (ctx) => {
  try {
    const userId = ctx.from.id;
    const username = ctx.from.username || 'ÐŸÐ°Ñ€Ñ‚Ð½ÐµÑ€';
    const firstName = ctx.from.first_name || '';
    
    // Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ»ÑƒÑ‡Ð°Ð¹Ð½Ñ‹Ð¹ ÐºÐ¾Ð´ Ð´Ð»Ñ Ð¿Ð°Ñ€Ñ‚Ð½ÐµÑ€ÑÐºÐ¾Ð¹ ÑÑÑ‹Ð»ÐºÐ¸
    const partnerCode = Math.random().toString(36).substring(2, 10).toUpperCase();
    const partnerLink = `http://localhost:3000/r/${partnerCode}`;
    
    const message = `
ðŸ‘‹ Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ, ${firstName}!

Ð’Ð°ÑˆÐ° Ð¿Ð°Ñ€Ñ‚Ð½ÐµÑ€ÑÐºÐ°Ñ ÑÑÑ‹Ð»ÐºÐ°:
ðŸ”— \`${partnerLink}\`

ðŸ“Š Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°:
â”œ Ð¡ÐµÐ³Ð¾Ð´Ð½Ñ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð¾Ð²: 0
â”œ WhatsApp: 0 | Telegram: 0
â”” Ð’ÑÐµÐ³Ð¾ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð¾Ð²: 0

Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð½Ð¸Ð¶Ðµ Ð´Ð»Ñ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ð¿Ð°Ð½ÐµÐ»Ð¸ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ:`;
    
    // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð´Ð»Ñ Web App
    const webAppUrl = `http://localhost:3000/webapp?userId=${userId}`;
    
    const keyboard = Markup.inlineKeyboard([
      [Markup.button.webApp('ðŸ“Š ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¿Ð°Ð½ÐµÐ»ÑŒ', webAppUrl)],
      [Markup.button.callback('ðŸ“‹ ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑÑÑ‹Ð»ÐºÑƒ', 'copy_link')],
      [Markup.button.callback('ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ', 'refresh_stats')]
    ]);
    
    await ctx.replyWithMarkdown(message, keyboard);
    
    console.log(`New user: ${userId} (@${username})`);
  } catch (error) {
    console.error('Error in /start:', error);
    await ctx.reply('ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ.');
  }
});

bot.on('callback_query', async (ctx) => {
  const action = ctx.callbackQuery.data;
  
  switch (action) {
    case 'copy_link':
      await ctx.answerCbQuery('Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ ÑÑÑ‹Ð»ÐºÑƒ Ð¸Ð· ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð²Ñ‹ÑˆÐµ');
      break;
    case 'refresh_stats':
      await ctx.answerCbQuery('Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð°');
      break;
    default:
      await ctx.answerCbQuery();
  }
});

bot.launch().then(() => {
  console.log('âœ… Ð‘Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!');
  console.log('ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Telegram Ð¸ Ð½Ð°Ð¹Ð´Ð¸Ñ‚Ðµ Ð²Ð°ÑˆÐµÐ³Ð¾ Ð±Ð¾Ñ‚Ð°');
  console.log('ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ /start');
});

// Enable graceful stop
process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));